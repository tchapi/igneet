{% extends 'metaUserBundle::layout.html.twig' %}

{% block title %}{{ parent() }} > {{ user.getFullName() }}{% endblock %}

{% block javascripts %}
  {{ parent() }}
  {% if isMe %}
    {% javascripts '@metaGeneralBundle/Resources/public/js-edit/bootstrap-editable.js' 
                   '@metaGeneralBundle/Resources/public/js-edit/editable.behaviour.js'
                   '@metaGeneralBundle/Resources/public/js-edit/markdown-editor/*' 
            filter='?yui_js' %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
  {% endif %}
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  {% stylesheets  'bundles/metageneral/css-edit/bootstrap-editable.css' 
    filter='?yui_css,cssrewrite' %}
          <link rel="stylesheet" type="text/css" media="screen" href="{{ asset_url }}" />
  {% endstylesheets %}
{% endblock %}

{% block header %}

  <div class="headerAvatarAndActions">
    {% if isMe %}<div class="changeAvatar"><a href="{{ path('u_edit_user_profile_reset_avatar', {'username': user.username, 'token': csrf_token('resetAvatar') }) }}" title="{{ "picture.resetHelp"|trans }}"><i class="icon-trash"></i></a> | <a href="{{ path('g_choose_file', {'targetAsBase64': targetAvatarAsBase64, 'token': csrf_token('edit') }) }}"><i class="icon-pencil"></i> {{ "picture.change"|trans }}</a></div>{% endif %}
    <img src="{{ asset(user.getAvatar()) }}" width="150" height="150" class="avatar"/>
{% if alreadyFollowing %}
    <a href="{{ path('u_unfollow_user', {'username': user.username, 'token': csrf_token('unfollowUser') }) }}" class="btn btn-info followAction">{{ "user.unfollow"|trans }} {{ user.firstName }}</a>
{% elseif not isMe %}
    <a href="{{ path('u_follow_user', {'username': user.username, 'token': csrf_token('followUser') }) }}" class="btn btn-success followAction">{{ "user.follow"|trans }} {{ user.firstName }}</a>
{% endif %}
  </div>

  <div class="userInfo">

    <h2 class="ellipsis">
      <span data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" data-name="first_name" data-title="{{ "user.name.first.help"|trans }}" class="editable">{{ user.firstName }}</span> <span data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" data-name="last_name" data-title="{{ "user.name.last.help"|trans }}" class="editable">{{ user.lastName }}</span>
    </h2>

    <h4 class="ellipsis">
      <span data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" data-name="headline" data-emptytext="{{ "user.headline.emptyText"|trans }}" data-type="text" data-title="{{ "user.headline.help"|trans }}" class="editable" title="{{ user.headline }}">{{ user.headline }}</span>
    </h4>

    <div>
      <i class="icon-map-marker"></i> <span data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" data-name="city" data-title="{{ "user.city.help"|trans }}" data-emptytext="{{ "user.city.emptyText"|trans }}" class="editable">{{ user.city }}</span>
    </div>

    <div>
      <i class="icon-calendar"></i> {{ "user.list.member.since"|trans({ '%date%': user.createdAt|date("date.format"|trans)}) }}
    </div>

    <div>
      <i class="icon-trophy"></i> 

      {% if user.skills|length > 0 %}
      {{ "user.skills.title"|trans }} : 
      {% elseif not isMe %}
      {{ "user.skills.none"|trans }}
      {% endif %}

      <ul data-toggle="manual" data-title="{{ "user.skills.help"|trans }}" data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" data-emptytext="{{ "user.skills.emptyText"|trans }}" data-type="checklist" data-source="{{ path('u_list_all_skills') }}" data-name="skills" class="skills skills-target editable-li">
      {% for skill in user.skills %}
          <li class="label" style="background-color: #{{ skill.color }}" rel="{{ skill.slug }}">{{ (skill.slug ~ ".name")|trans({}, 'skills') }}</li>
      {% endfor %}
      </ul>

      {% if isMe %}
        <a class="editable-trigger" data-target="skills">&hellip;<i class="icon-pencil"></i></a>
      {% endif %}

    </div>
  </div>
{% endblock %}

{% block content %}
{% if isMe %}
<section>
  <div class="sectionTitle">{{ "user.email.title"|trans }} : </div>
  <div class="users sectionContent">
    <span class="editable" data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" data-name="email" data-emptytext="{{ "user.email.emptyText"|trans }}" data-type="text" data-title="{{ "user.email.help"|trans }}">{{ user.email }}</span> <em>({{ "user.email.info"|trans }})</em>
  </div>
</section>
<section>
  <div class="sectionTitle">{{ "user.password"|trans }} : </div>
  <div class="users sectionContent">
    <a href="{{ path('change_password', {'token': csrf_token('changePassword')} ) }}">{{ "user.passwordChange.title"|trans }}</a>
  </div>
</section>
{% endif %}
<section>
  <div class="wmd-heading"><i class="icon-bullhorn"></i> {{ "user.about"|trans({ '%user%': user.getFullName}) }}{% if isMe %}<a class="pull-right markdown-trigger">&hellip;<i class="icon-pencil"></i></a>{% endif %}</div>
  <div>

    {% if isMe %}
      <div class="wmd-message-top hide alert"><i class="icon-warning-sign"></i> {{ "unsaved.changes"|trans }}</div>
      <div class="wmd-wrapper well well-small hide" >
        <div class="wmd-panel">
            <div id="wmd-button-bar"></div>
            <textarea unsaved='no' data-name="about" data-url="{{ path('u_edit_user_profile', {'username': user.username, 'token': csrf_token('edit') }) }}" class="wmd-input" id="wmd-input">{{ user.about }}</textarea>
        </div>
        <div>
          <button id="wmd-save" class="btn btn-primary">{{ "save"|trans }}</button> <span class="muted wmd-message">{{ "saveHelp"|trans }}</span>
        </div>
        <div id="wmd-preview" class="preview">{{ user.about }}</div>
      </div>
    {% endif %}

    <div class="content">{{ user.about|deeplinks|markdown }}</div>

  </div>
</section>

{% if following|length > 0 %}
<section class="colored first">
<div class="sectionTitle">{{ "user.followers"|trans({'%user%': user.firstName }) }} : </div>
<ul class="users sectionContent">
{% for followingUser in following %}
  <li>
    <a href="{{ path('u_show_user_profile', {'username': followingUser.username}) }}">
      <img src="{{ followingUser.avatar }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span><div>{{ followingUser.firstName }}</div><div>{{ followingUser.lastName }}</div></span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if isMe and followers|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.followers"|trans }} : </div>
<ul class="users sectionContent">
{% for followerUser in followers %}
  <li>
    <a href="{{ path('u_show_user_profile', {'username': followerUser.username}) }}">
      <img src="{{ followerUser.avatar }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span><div>{{ followerUser.firstName }}</div><div>{{ followerUser.lastName }}</div></span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if isMe and projectsWatched|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.projects.watched"|trans }} :</div>
<ul class="projects sectionContent">
{% for watchedProject in projectsWatched %}
  <li>
    <a href="{{ path('sp_show_project', {'slug': watchedProject.slug}) }}">
      <img src="{{ watchedProject.picture }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span>{{ watchedProject.name }}</span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if projectsOwned|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.projects.owned"|trans }} :</div>
<ul class="projects sectionContent">
{% for ownedProject in projectsOwned %}
  <li>
    <a href="{{ path('sp_show_project', {'slug': ownedProject.slug}) }}">
      <img src="{{ ownedProject.picture }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span>{{ ownedProject.name }}</span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if projectsParticipatedIn|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.projects.participated"|trans }} :</div>
<ul class="projects sectionContent">
{% for participatedInProject in projectsParticipatedIn %}
  <li>
    <a href="{{ path('sp_show_project', {'slug': participatedInProject.slug}) }}">
      <img src="{{ participatedInProject.picture }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span>{{ participatedInProject.name }}</span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if isMe and ideasWatched|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.ideas.watched"|trans }} :</div>
<ul class="projects sectionContent">
{% for idea in ideasWatched %}
  <li>
    <a href="{{ path('i_show_idea', {'id': idea.id}) }}">
      <img src="{{ idea.picture }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span>{{ idea.name }}</span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if ideasCreated|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.ideas.initiated"|trans }} :</div>
<ul class="projects sectionContent">
{% for idea in ideasCreated %}
  <li>
    <a href="{{ path('i_show_idea', {'id': idea.id}) }}">
      <img src="{{ idea.picture }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span>{{ idea.name }}</span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

{% if ideasParticipatedIn|length > 0 %}
<section class="colored">
<div class="sectionTitle">{{ "user.ideas.participated"|trans }} :</div>
<ul class="projects sectionContent">
{% for idea in ideasParticipatedIn %}
  <li>
    <a href="{{ path('i_show_idea', {'id': idea.id}) }}">
      <img src="{{ idea.picture }}" width="70" height="70" class="smallAvatar"/>
      <div class="smallObjectInfos ellipsis-multiline">
        <span>{{ idea.name }}</span>
      </div>
    </a>
  </li>
{% endfor %}
</ul>
</section>
{% endif %}

<section class="colored">
  <div class="sectionTitle">{{ "user.activity"|trans }} :</div>
  <div class="projects sectionContent">
    {{ "user.dashboard.comments"|transchoice(user.comments|length, { '%count%': user.comments|length, '%public%': user.countPublicComments }) }}
  </div>
</section>
{% if isMe %}
<section class="colored warning">
  <div class="sectionTitle">{{ "user.delete"|trans }} : </div>
  <div class="sectionContent"><a class="btn btn-danger" data-confirm="{{ "user.deleteHelp"|trans }}" href="{{ path('u_delete_user_profile', { 'username': user.username, 'token': csrf_token('delete') }) }}">{{ "delete"|trans }}</a> <span class="muted">( <i class="icon-warning-sign"></i> {{ "deleteHelp"|trans }} )</span></div>
</section>
{% endif %}
{% endblock %}
